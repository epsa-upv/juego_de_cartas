<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Unirse a una partida de Oh Hell!">
    <title>Unirse a Partida - Oh Hell!</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="page-container">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="container">
                <div class="navbar-content">
                    <a href="home.html" class="navbar-brand">
                        <span class="navbar-logo">üé¥</span>
                        OH HELL!
                    </a>

                    <div class="navbar-menu">
                        <a href="home.html" class="btn btn-outline btn-sm">‚Üê Volver</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="content-wrapper">
            <div class="join-game-container">
                <div class="join-game-header">
                    <h1 class="join-game-title">üîì Unirse a Partida</h1>
                    <p class="join-game-subtitle">Ingresa el c√≥digo de la partida para unirte</p>
                </div>

                <!-- Formulario de unirse -->
                <div class="join-game-card">
                    <div class="form-section">
                        <h2 class="section-title">üìù C√≥digo de Partida</h2>

                        <div class="form-group">
                            <label for="game-code-input" class="form-label">Ingresa el c√≥digo compartido</label>
                            <input
                                type="text"
                                id="game-code-input"
                                name="gameCode"
                                class="form-input form-input-large"
                                placeholder="Ej: 1, 2, 3..."
                                maxlength="10"
                                autocomplete="off"
                            />
                            <small class="form-help">Pide el c√≥digo a quien cre√≥ la partida</small>
                        </div>

                        <div class="form-group">
                            <button class="btn btn-primary btn-lg btn-full" id="join-btn">
                                üîì Unirse a Partida
                            </button>
                        </div>
                    </div>

                    <!-- Info √∫til -->
                    <div class="info-box">
                        <h3 class="info-title">‚ÑπÔ∏è ¬øC√≥mo unirse?</h3>
                        <ol class="info-list">
                            <li>Pide el c√≥digo de la partida a quien la cre√≥</li>
                            <li>Ingresa el c√≥digo en el campo arriba</li>
                            <li>Haz clic en "Unirse a Partida"</li>
                            <li>¬°Se abrir√° la sala de espera autom√°ticamente!</li>
                        </ol>
                    </div>

                    <!-- Partidas disponibles -->
                    <div class="form-section" style="margin-top: var(--space-8);">
                        <h2 class="section-title">üéÆ Partidas Disponibles</h2>
                        <p class="section-subtitle">Estas partidas est√°n esperando jugadores:</p>

                        <div class="games-list" id="games-list">
                            <div class="game-loading">
                                <p>Cargando partidas disponibles...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alternativa: Crear nueva -->
                <div class="alternative-box">
                    <h3 class="alternative-title">¬øNo encuentras la partida?</h3>
                    <p class="alternative-text">Crea una nueva partida y comparte el c√≥digo con tus amigos</p>
                    <a href="create-game.html" class="btn btn-secondary btn-lg btn-full">
                        üéÆ Crear Partida Nueva
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p class="footer-text">Oh Hell! Game ¬© 2025 - Tom√°s Engonga Ovono Nsuga</p>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/waiting-room.js"></script>
    <script src="js/game.js"></script>
    <script src="js/main.js"></script>

    <script>
        // Variables globales
        let currentPlayer = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìù P√°gina de Unirse a Partida inicializada');

            currentPlayer = gameState.getCurrentPlayer();
            if (!currentPlayer) {
                uiManager.showError('No hay jugador autenticado');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            cargarPartidasDisponibles();
        });

        // Cargar partidas disponibles
        async function cargarPartidasDisponibles() {
            try {
                const games = await apiClient.getAvailableGames();
                console.log('Partidas disponibles:', games);

                const gamesList = document.getElementById('games-list');

                if (!games || games.length === 0) {
                    gamesList.innerHTML = `
                        <div class="no-games">
                            <p>No hay partidas disponibles en este momento</p>
                            <p class="text-muted">Crea una nueva o espera a que alguien comparta su c√≥digo</p>
                        </div>
                    `;
                    return;
                }

                gamesList.innerHTML = games.map((game, index) => `
                    <div class="game-card">
                        <div class="game-card-header">
                            <div class="game-card-id">Partida #${game.id || game.gameId}</div>
                            <div class="game-players-badge">${(game.playerIds || []).length}/${game.maxPlayers || 4}</div>
                        </div>
                        <div class="game-card-body">
                            <div class="game-info-item">
                                <span class="info-label">Jugadores:</span>
                                <span class="info-value">${(game.playerIds || []).length} de ${game.maxPlayers || 4}</span>
                            </div>
                            <div class="game-info-item">
                                <span class="info-label">Vidas:</span>
                                <span class="info-value">${game.initialLives || 5}</span>
                            </div>
                            <div class="game-info-item">
                                <span class="info-label">Rondas:</span>
                                <span class="info-value">${game.maxRounds || 10}</span>
                            </div>
                        </div>
                        <div class="game-card-footer">
                            <button class="btn btn-secondary btn-sm btn-full" onclick="unirsePorId('${game.id || game.gameId}')">
                                Unirse
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error cargando partidas:', error);
                const gamesList = document.getElementById('games-list');
                gamesList.innerHTML = `
                    <div class="no-games">
                        <p>Error al cargar las partidas disponibles</p>
                    </div>
                `;
            }
        }

        // Unirse a partida por c√≥digo
        const joinBtn = document.getElementById('join-btn');
        if (joinBtn) {
            joinBtn.addEventListener('click', async () => {
                const codigo = document.getElementById('game-code-input').value.trim();

                if (!codigo) {
                    uiManager.showError('Por favor ingresa un c√≥digo de partida');
                    return;
                }

                await unirsePorId(codigo);
            });
        }

        // Unirse a partida
        async function unirsePorId(gameId) {
            uiManager.showLoading('Uni√©ndose a la partida...');

            try {
                console.log(`üîì Intentando unirse a partida ${gameId}...`);

                // Obtener datos de la partida
                const game = await apiClient.getGame(gameId);

                if (!game) {
                    uiManager.hideLoading();
                    uiManager.showError('Partida no encontrada');
                    return;
                }

                console.log('‚úÖ Partida encontrada:', game);

                // Guardar la partida en el estado
                gameState.setCurrentGame(game);

                uiManager.hideLoading();
                uiManager.showSuccess('¬°Te has unido a la partida!');

                setTimeout(() => {
                    window.location.href = `waiting-room.html?gameId=${gameId}`;
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error al unirse:', error);
                uiManager.hideLoading();

                if (error.message.includes('no encontrada') || error.message.includes('404') || error.message.includes('not found')) {
                    uiManager.showError('Partida no encontrada. Verifica el c√≥digo.');
                } else if (error.message.includes('llena') || error.message.includes('completa')) {
                    uiManager.showError('La partida est√° llena. No hay lugares disponibles.');
                } else {
                    uiManager.showError(error.message || 'Error al unirse a la partida. Intenta de nuevo.');
                }
            }
        }

        // Enter para unirse
        document.getElementById('game-code-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('join-btn').click();
            }
        });

        // Recargar partidas cada 5 segundos
        setInterval(cargarPartidasDisponibles, 5000);
    </script>
</body>
</html>

